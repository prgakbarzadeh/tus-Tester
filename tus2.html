<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ø§ Tus Ùˆ JWT</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 700px;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        h2 {
            color: #4f46e5;
            margin: 20px 0 10px 0;
            font-size: 20px;
        }
        
        .server-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: right;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .token-section {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: right;
        }
        
        .token-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .token-status.valid {
            background: #10b981;
            color: white;
        }
        
        .token-status.invalid {
            background: #ef4444;
            color: white;
        }
        
        .token-status.expired {
            background: #f59e0b;
            color: white;
        }
        
        .upload-section {
            background: #f0fdf4;
            border: 2px solid #bbf7d0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .upload-area {
            border: 3px dashed #22c55e;
            border-radius: 15px;
            padding: 40px 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fee7;
        }
        
        .upload-area:hover {
            background: #ecfccb;
            border-color: #16a34a;
        }
        
        .upload-area.dragover {
            background: #dcfce7;
            border-color: #22c55e;
        }
        
        .upload-icon {
            font-size: 60px;
            margin-bottom: 15px;
            color: #22c55e;
        }
        
        .file-info {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: right;
        }
        
        button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
        
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }
        
        button.secondary {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .progress-container {
            margin: 20px 0;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 24px;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 24px;
            font-weight: bold;
        }
        
        .status-box {
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
        }
        
        .status-box.success {
            background: #d1fae5;
            border-color: #10b981;
        }
        
        .status-box.error {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        .status-box.info {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .status-box.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .log-section {
            margin-top: 25px;
            border-top: 2px solid #e2e8f0;
            padding-top: 20px;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #334155;
        }
        
        .log-timestamp {
            color: #94a3b8;
            margin-left: 10px;
        }
        
        .log-message {
            color: #e2e8f0;
        }
        
        .log-error {
            color: #f87171;
        }
        
        .log-success {
            color: #34d399;
        }
        
        .log-warning {
            color: #fbbf24;
        }
        
        .log-info {
            color: #60a5fa;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        
        .info-label {
            font-weight: bold;
            color: #475569;
            min-width: 100px;
        }
        
        .info-value {
            color: #1e293b;
            text-align: left;
            flex: 1;
        }
        
        .debug-section {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .debug-section h3 {
            color: #dc2626;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ØªØ³Øª Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ø§ Tus + JWT</h1>
        
        <!-- Ø¨Ø®Ø´ Ø³Ø±ÙˆØ± -->
        <div class="server-section">
            <h2>ğŸŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ±</h2>
            <div class="input-group">
                <input type="text" id="serverUrl" value="https://localhost:7010" placeholder="Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± (Ù…Ø«Ø§Ù„: https://localhost:7010)">
            </div>
            <div class="button-group">
                <button onclick="testServerConnection()" class="secondary">ğŸ” ØªØ³Øª Ø§ØªØµØ§Ù„</button>
                <button onclick="showDebugInfo()" class="secondary">ğŸ› Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯</button>
            </div>
        </div>
        
        <!-- Ø¨Ø®Ø´ ØªÙˆÚ©Ù† -->
        <div class="token-section">
            <h2>ğŸ” ØªÙˆÚ©Ù† JWT</h2>
            <div style="margin-bottom: 15px;">
                <span>ÙˆØ¶Ø¹ÛŒØª:</span>
                <span class="token-status invalid" id="tokenStatus">Ù†Ø§Ù…Ø¹ØªØ¨Ø±</span>
            </div>
            <div class="input-group">
                <input type="text" id="jwtTokenInput" placeholder="ØªÙˆÚ©Ù† JWT Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ paste Ú©Ù†ÛŒØ¯...">
                <button onclick="setToken()">âœ… Ø«Ø¨Øª ØªÙˆÚ©Ù†</button>
                <button onclick="clearToken()" class="danger">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            </div>
            <div class="button-group">
                <button onclick="testToken()" class="secondary">ğŸ” ØªØ³Øª ØªÙˆÚ©Ù†</button>
                <button onclick="copyToken()" id="copyTokenBtn" disabled>ğŸ“‹ Ú©Ù¾ÛŒ ØªÙˆÚ©Ù†</button>
            </div>
            <div id="tokenInfo" style="margin-top: 15px; font-size: 12px; color: #64748b; display: none;">
                ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª
            </div>
        </div>
        
        <!-- Ø¨Ø®Ø´ Ø¢Ù¾Ù„ÙˆØ¯ -->
        <div class="upload-section">
            <h2>ğŸ“ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„</h2>
            
            <div class="upload-area" id="dropArea">
                <div class="upload-icon">ğŸ“</div>
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                    ÙØ§ÛŒÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯
                </div>
                <div style="color: #666; margin-bottom: 20px;">
                    ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯
                </div>
                <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
                <button onclick="document.getElementById('fileInput').click()">
                    ğŸ“‚ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„
                </button>
            </div>
            
            <div id="fileInfo" class="file-info" style="display: none;">
                <div class="info-row">
                    <span class="info-label">Ù†Ø§Ù… ÙØ§ÛŒÙ„:</span>
                    <span class="info-value" id="fileName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ø­Ø¬Ù…:</span>
                    <span class="info-value" id="fileSize"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ù†ÙˆØ¹:</span>
                    <span class="info-value" id="fileType"></span>
                </div>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <div class="button-group">
                <button id="uploadBtn" onclick="startUpload()" disabled style="padding: 15px 30px; font-size: 18px;">
                    ğŸš€ Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯
                </button>
                <button onclick="clearFile()" class="danger">âŒ Ø­Ø°Ù ÙØ§ÛŒÙ„</button>
            </div>
            
            <div class="status-box info" id="statusBox">
                <div>ğŸ“‹ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„:</div>
                <div style="font-size: 14px; margin-top: 10px;">
                    1. Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯<br>
                    2. ØªÙˆÚ©Ù† JWT Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯<br>
                    3. ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯<br>
                    4. Ø¯Ú©Ù…Ù‡ "Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯
                </div>
            </div>
        </div>
        
        <!-- Ø¨Ø®Ø´ Ø¯ÛŒØ¨Ø§Ú¯ (Ù…Ø®ÙÛŒ) -->
        <div class="debug-section" id="debugSection">
            <h3>ğŸ› Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯</h3>
            <div id="debugInfo"></div>
        </div>
        
        <!-- Ø¨Ø®Ø´ Ù„Ø§Ú¯ -->
        <div class="log-section">
            <div class="log-header">
                <h2>ğŸ“ Ù„Ø§Ú¯ Ø³ÛŒØ³ØªÙ…</h2>
                <div class="button-group">
                    <button onclick="copyLog()" class="success">ğŸ“‹ Ú©Ù¾ÛŒ Ù„Ø§Ú¯</button>
                    <button onclick="clearLog()" class="danger">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
                    <button onclick="toggleLog()" class="secondary">ğŸ‘ï¸ Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ</button>
                </div>
            </div>
            <div class="log-container" id="logContainer" style="display: block;">
                <!-- Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
        </div>
    </div>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        let jwtToken = null;
        let tokenExpiration = null;
        let selectedFile = null;
        let uploadUrl = null;
        let serverBaseUrl = 'https://localhost:7010';
        let logVisible = true;

        // ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯â€ŒÙ†ÙˆÛŒØ³ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message log-${type}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„Ø§Ú¯ Ù‡Ù†Ú¯Ø§Ù… Ø®Ø·Ø§ ÛŒØ§ Ù‡Ø´Ø¯Ø§Ø±
            if (type === 'error' || type === 'warning') {
                logContainer.style.display = 'block';
                logVisible = true;
            }
            
            // Ù‡Ù…Ú†Ù†ÛŒÙ† Ø¯Ø± console Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
            const consoleMessage = `[${timestamp}] ${message}`;
            switch(type) {
                case 'error':
                    console.error(consoleMessage);
                    break;
                case 'warning':
                    console.warn(consoleMessage);
                    break;
                case 'success':
                    console.log('%c' + consoleMessage, 'color: green');
                    break;
                default:
                    console.log(consoleMessage);
            }
        }

        // Ú©Ù¾ÛŒ Ù„Ø§Ú¯ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯
        function copyLog() {
            const logContainer = document.getElementById('logContainer');
            let logText = '';
            
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§
            const logEntries = logContainer.querySelectorAll('.log-entry');
            logEntries.forEach(entry => {
                logText += entry.textContent + '\n';
            });
            
            if (!logText.trim()) {
                logText = 'Ù„Ø§Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            }
            
            navigator.clipboard.writeText(logText).then(() => {
                addLog('âœ… Ù„Ø§Ú¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
                showNotification('Ù„Ø§Ú¯ Ú©Ù¾ÛŒ Ø´Ø¯!', 'success');
            }).catch(err => {
                addLog('âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ù„Ø§Ú¯: ' + err.message, 'error');
            });
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
        function showNotification(message, type = 'info') {
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ù†ØµØ± Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
            const notification = document.createElement('div');
            notification.className = `status-box ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                min-width: 300px;
                text-align: center;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
        async function testServerConnection() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            if (!serverUrl) {
                addLog('âŒ Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            addLog('ğŸ” ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...', 'info');
            
            try {
                // ØªØ³Øª Ú†Ù†Ø¯ÛŒÙ† endpoint
const endpoints = [
    '/',
    '/tus',  // Ø§ÛŒÙ† Ø§ØµÙ„ÛŒâ€ŒØªØ±ÛŒÙ† endpoint Ø§Ø³Øª
    '/uploads',
    '/api/document'
];
                let successfulTests = 0;
                
                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(serverUrl + endpoint, {
                            method: 'HEAD',
                            headers: {
                                'Tus-Resumable': '1.0.0'
                            }
                        });
                        
                        if (response.ok || response.status === 405 || response.status === 404) {
                            successfulTests++;
                            addLog(`âœ“ ${endpoint} Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯ (Ú©Ø¯: ${response.status})`, 'success');
                        } else {
                            addLog(`âœ— ${endpoint} Ø®Ø·Ø§: ${response.status}`, 'warning');
                        }
                    } catch (error) {
                        addLog(`âœ— ${endpoint} Ø®Ø·Ø§: ${error.message}`, 'error');
                    }
                    
                    // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (successfulTests > 0) {
                    serverBaseUrl = serverUrl;
                    addLog(`âœ… Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª (${successfulTests}/${endpoints.length} endpoint Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯)`, 'success');
                    showNotification(`Ø³Ø±ÙˆØ± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª!`, 'success');
                } else {
                    addLog('âŒ Ù‡ÛŒÚ† endpoint Ù¾Ø§Ø³Ø® Ù†Ø¯Ø§Ø¯. Ø³Ø±ÙˆØ± Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†Ø¨Ø§Ø´Ø¯', 'error');
                }
                
            } catch (error) {
                addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
            }
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯
        function showDebugInfo() {
            const debugSection = document.getElementById('debugSection');
            const debugInfo = document.getElementById('debugInfo');
            
            const info = `
                <div class="info-row">
                    <span class="info-label">Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ±:</span>
                    <span class="info-value">${document.getElementById('serverUrl').value}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ØªÙˆÚ©Ù† ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡:</span>
                    <span class="info-value">${jwtToken ? 'âœ“ Ø¨Ù„Ù‡' : 'âœ— Ø®ÛŒØ±'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</span>
                    <span class="info-value">${selectedFile ? selectedFile.name : 'Ø®ÛŒØ±'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">User Agent:</span>
                    <span class="info-value">${navigator.userAgent}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Online Status:</span>
                    <span class="info-value">${navigator.onLine ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'}</span>
                </div>
            `;
            
            debugInfo.innerHTML = info;
            debugSection.style.display = 'block';
            
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    debugInfo.innerHTML += `
                        <div class="info-row">
                            <span class="info-label">IP Ø¹Ù…ÙˆÙ…ÛŒ:</span>
                            <span class="info-value">${data.ip}</span>
                        </div>
                    `;
                })
                .catch(() => {
                    // ignore
                });
        }

        // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù† (Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„)
        function setToken() {
            const tokenInput = document.getElementById('jwtTokenInput').value.trim();
            
            if (!tokenInput) {
                addLog('âŒ Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† JWT Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± ØªÙˆÚ©Ù†
                const parts = tokenInput.split('.');
                if (parts.length !== 3) {
                    throw new Error('ÙØ±Ù…Øª ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }
                
                jwtToken = tokenInput;
                const tokenPayload = parseJwt(jwtToken);
                tokenExpiration = tokenPayload.exp ? new Date(tokenPayload.exp * 1000) : null;
                
                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                document.getElementById('tokenStatus').textContent = 'Ù…Ø¹ØªØ¨Ø±';
                document.getElementById('tokenStatus').className = 'token-status valid';
                document.getElementById('copyTokenBtn').disabled = false;
                
                // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆÚ©Ù†
                const tokenInfo = document.getElementById('tokenInfo');
                tokenInfo.style.display = 'block';
                tokenInfo.innerHTML = `
                    Ú©Ø§Ø±Ø¨Ø±: ${tokenPayload.sub || 'Ù†Ø§Ù…Ø´Ø®Øµ'} | 
                    Ø§Ù†Ù‚Ø¶Ø§: ${tokenExpiration ? tokenExpiration.toLocaleTimeString('fa-IR') : 'Ø¨Ø¯ÙˆÙ† Ø§Ù†Ù‚Ø¶Ø§'}
                `;
                
                addLog(`âœ… ØªÙˆÚ©Ù† ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯ - Ú©Ø§Ø±Ø¨Ø±: ${tokenPayload.sub || 'Ù†Ø§Ù…Ø´Ø®Øµ'}`, 'success');
                showNotification('ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯!', 'success');
                
                checkUploadReady();
                
            } catch (error) {
                addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÚ©Ù†: ${error.message}`, 'error');
                clearToken();
            }
        }

        function clearToken() {
            jwtToken = null;
            document.getElementById('jwtTokenInput').value = '';
            document.getElementById('tokenStatus').textContent = 'Ù†Ø§Ù…Ø¹ØªØ¨Ø±';
            document.getElementById('tokenStatus').className = 'token-status invalid';
            document.getElementById('tokenInfo').style.display = 'none';
            document.getElementById('copyTokenBtn').disabled = true;
            
            addLog('ğŸ—‘ï¸ ØªÙˆÚ©Ù† Ù¾Ø§Ú© Ø´Ø¯', 'info');
            checkUploadReady();
        }

        // Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ (Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) Ø¨Ø§ Ø§ØµÙ„Ø§Ø­Ø§Øª Ú©ÙˆÚ†Ú©
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch {
                throw new Error('ØªÙˆÚ©Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            }
        }

        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                selectedFile = file;
                showFileInfo(file);
                checkUploadReady();
                addLog(`ğŸ“„ ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯: ${file.name} (${formatBytes(file.size)})`, 'success');
            }
        }

        function showFileInfo(file) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            document.getElementById('fileType').textContent = file.type || 'Ù†Ø§Ù…Ø´Ø®Øµ';
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            
            addLog('ğŸ—‘ï¸ ÙØ§ÛŒÙ„ Ø­Ø°Ù Ø´Ø¯', 'info');
            checkUploadReady();
        }

        function checkUploadReady() {
            const uploadBtn = document.getElementById('uploadBtn');
            const statusBox = document.getElementById('statusBox');
            
            if (jwtToken && selectedFile) {
                const now = new Date();
                if (tokenExpiration && tokenExpiration < now) {
                    statusBox.className = 'status-box warning';
                    statusBox.innerHTML = 'âš ï¸ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
                    uploadBtn.disabled = true;
                } else {
                    statusBox.className = 'status-box success';
                    statusBox.innerHTML = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡ Ø¢Ù¾Ù„ÙˆØ¯! Ø¯Ú©Ù…Ù‡ "Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯" Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯';
                    uploadBtn.disabled = false;
                }
            } else {
                uploadBtn.disabled = true;
                if (!jwtToken && !selectedFile) {
                    statusBox.className = 'status-box info';
                    statusBox.innerHTML = 'ğŸ“‹ Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† JWT Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡ Ùˆ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                } else if (!jwtToken) {
                    statusBox.className = 'status-box warning';
                    statusBox.innerHTML = 'âš ï¸ ØªÙˆÚ©Ù† JWT ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª';
                } else {
                    statusBox.className = 'status-box warning';
                    statusBox.innerHTML = 'âš ï¸ ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª';
                }
            }
        }


async function startUpload() {
    if (!selectedFile || !jwtToken) return;
    
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const statusBox = document.getElementById('statusBox');
    
    uploadBtn.disabled = true;
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    
    statusBox.className = 'status-box info';
    statusBox.innerHTML = 'ğŸš€ Ø¯Ø± Ø­Ø§Ù„ Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯...';
    
    addLog('ğŸš€ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø¢Ù¾Ù„ÙˆØ¯...', 'info');
    
    try {
        const serverUrl = document.getElementById('serverUrl').value.trim();
        const baseUrl = serverUrl.endsWith('/') ? serverUrl.slice(0, -1) : serverUrl;
        
        addLog(`ğŸŒ Ø³Ø±ÙˆØ±: ${baseUrl}`, 'info');
        addLog(`ğŸ“ ÙØ§ÛŒÙ„: ${selectedFile.name} (${formatBytes(selectedFile.size)})`, 'info');
        
        // ØªÙˆÙ„ÛŒØ¯ ÛŒÚ© FileId Ù…Ù†Ø­ØµØ±Ø¨ÙØ±Ø¯
        const fileId = 'tus_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Ø³Ø§Ø®Øª URL Ø¢Ù¾Ù„ÙˆØ¯ - ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Tus Ø§Ø² Ø§ÛŒÙ† Ø§Ù„Ú¯Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        uploadUrl = `${baseUrl}/tus/${fileId}`;
        
        addLog(`ğŸ”§ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù† Ø¨Ø§ FileId: ${fileId}`, 'info');
        
        // Ø±ÙˆØ´ 1: Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ POST Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù†
        addLog('ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù† Ø¢Ù¾Ù„ÙˆØ¯ (POST)...', 'info');
        
        const createResponse = await fetchWithRetry(`${baseUrl}/tus`, {
            method: 'POST',
            headers: {
                'Tus-Resumable': '1.0.0',
                'Upload-Length': selectedFile.size.toString(),
                'Upload-Metadata': `filename ${btoa(selectedFile.name)},contentType ${btoa(selectedFile.type || 'application/octet-stream')}`,
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/offset+octet-stream'
            }
        }, 3);

        addLog(`ğŸ“¥ ÙˆØ¶Ø¹ÛŒØª POST: ${createResponse.status}`, 'info');
        
        // Ø§Ú¯Ø± 201 Ø¨ÙˆØ¯ Ø§Ù…Ø§ Location Ù†Ø¯Ø§Ø´ØªØŒ Ø§Ø² FileId Ø®ÙˆØ¯Ù…Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        if (createResponse.status === 201 || createResponse.status === 204) {
            const location = createResponse.headers.get('Location');
            if (location) {
                uploadUrl = location.startsWith('/') ? baseUrl + location : location;
                addLog(`ğŸ“ Ø¢Ø¯Ø±Ø³ Ø§Ø² Location: ${uploadUrl}`, 'success');
            } else {
                addLog(`âš ï¸ Location header Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ${uploadUrl}`, 'warning');
                
                // ØªØ³Øª Ú©Ù†ÛŒÙ… Ú©Ù‡ Ø¢ÛŒØ§ Ø§ÛŒÙ† URL Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                const headResponse = await fetch(uploadUrl, {
                    method: 'HEAD',
                    headers: {
                        'Tus-Resumable': '1.0.0',
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });
                
                if (headResponse.ok) {
                    addLog(`âœ… Ø³Ø´Ù† Ø¨Ø§ FileId ${fileId} Ø¯Ø± Ø³Ø±ÙˆØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯`, 'success');
                } else if (headResponse.status === 404) {
                    // Ø³Ø´Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù¾Ø³ Ø¨Ø§ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒÙ…
                    addLog('ğŸ†• Ø³Ø´Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù† Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ PATCH...', 'info');
                    
                    // Ø¨Ø¹Ø¶ÛŒ Ø§Ø² Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒâ€ŒÙ‡Ø§ÛŒ Tus Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§ PATCH Ø³Ø´Ù† Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯
                    const patchResponse = await fetch(uploadUrl, {
                        method: 'PATCH',
                        headers: {
                            'Tus-Resumable': '1.0.0',
                            'Upload-Offset': '0',
                            'Upload-Length': selectedFile.size.toString(),
                            'Content-Type': 'application/offset+octet-stream',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: new ArrayBuffer(0) // Ø¨Ø¯Ù†Û€ Ø®Ø§Ù„ÛŒ
                    });
                    
                    if (patchResponse.status === 201 || patchResponse.status === 204) {
                        addLog('âœ… Ø³Ø´Ù† Ø¨Ø§ PATCH Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                    } else {
                        // Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² upload creation extension
                        addLog('ğŸ”„ Ø§Ù…ØªØ­Ø§Ù† Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†...', 'info');
                    }
                }
            }
        } else {
            const errorText = await createResponse.text();
            throw new Error(`Ø®Ø·Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù†: ${createResponse.status} - ${errorText}`);
        }
        
        // Ø­Ø§Ù„Ø§ Ø¢Ù¾Ù„ÙˆØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        addLog('ğŸ“¤ Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„...', 'success');
        statusBox.innerHTML = 'ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„...';
        
        // Ù…Ø±Ø­Ù„Ù‡ 2: Ø¢Ù¾Ù„ÙˆØ¯ chunkÙ‡Ø§
        await uploadChunks(uploadUrl, selectedFile, jwtToken);
        
        // Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ù…ÛŒÙ„
        await verifyUploadCompletion(uploadUrl, jwtToken);
        
        statusBox.className = 'status-box success';
        statusBox.innerHTML = 'ğŸ‰ Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!';
        
        showNotification('Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯!', 'success');
        
    } catch (error) {
        console.error('Ø®Ø·Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯:', error);
        statusBox.className = 'status-box error';
        statusBox.innerHTML = `âŒ Ø®Ø·Ø§: ${error.message}`;
        
        addLog(`âŒ Ø®Ø·Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯: ${error.message}`, 'error');
        
        uploadBtn.disabled = false;
    }
}


        // ØªØ§Ø¨Ø¹ Ø¢Ù¾Ù„ÙˆØ¯ chunkÙ‡Ø§ Ø¨Ø§ Ø±ÛŒÚ©ÙˆØ¦Ø³Øª retry
        async function uploadChunks(uploadUrl, file, token) {
            let offset = 0;
            const chunkSize = 512 * 1024; // 512KB chunks (Ú©ÙˆÚ†Ú©ØªØ± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†)
            const totalChunks = Math.ceil(file.size / chunkSize);
            
            addLog(`ğŸ“¦ Ø´Ø±ÙˆØ¹ Ø¢Ù¾Ù„ÙˆØ¯ ${totalChunks} Ø¨Ø®Ø´...`, 'info');
            
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                const start = chunkIndex * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);
                
                try {
                    const response = await fetchWithRetry(uploadUrl, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/offset+octet-stream',
                            'Upload-Offset': offset.toString(),
                            'Tus-Resumable': '1.0.0',
                            'Authorization': `Bearer ${token}`,
                            'Content-Length': (end - start).toString()
                        },
                        body: chunk
                    }, 3);

                    if (!response.ok) {
                        throw new Error(`Ø®Ø·Ø§ÛŒ chunk ${chunkIndex + 1}: ${response.status}`);
                    }

                    offset = parseInt(response.headers.get('Upload-Offset') || offset + (end - start));
                    
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ progress
                    const progress = Math.round((offset / file.size) * 100);
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('progressBar').textContent = `${progress}%`;
                    
                    addLog(`â†—ï¸ Ø¨Ø®Ø´ ${chunkIndex + 1}/${totalChunks} (${progress}%)`, 'info');
                    
                } catch (error) {
                    addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø®Ø´ ${chunkIndex + 1}: ${error.message}`, 'error');
                    throw error;
                }
            }
        }

        // ØªØ§Ø¨Ø¹ retry Ø¨Ø±Ø§ÛŒ fetch
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    // Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ø¨ÙˆØ¯ØŒ retry Ú©Ù†
                    if (!response.ok && i < maxRetries - 1) {
                        addLog(`âš ï¸ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø§Ù…ÙˆÙÙ‚ (ØªÙ„Ø§Ø´ ${i + 1}/${maxRetries})`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // ØªØ§Ø®ÛŒØ± ØªØµØ§Ø¹Ø¯ÛŒ
                        continue;
                    }
                    
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    addLog(`âš ï¸ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ (ØªÙ„Ø§Ø´ ${i + 1}/${maxRetries})`, 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
            throw new Error('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ Ù¾Ø³ Ø§Ø² Ú†Ù†Ø¯ÛŒÙ† ØªÙ„Ø§Ø´');
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯
        async function verifyUploadCompletion(uploadUrl, token) {
            addLog('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯...', 'info');
            
            const response = await fetch(uploadUrl, {
                method: 'HEAD',
                headers: {
                    'Tus-Resumable': '1.0.0',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const uploadLength = response.headers.get('Upload-Length');
                const uploadOffset = response.headers.get('Upload-Offset');
                
                if (uploadLength && uploadOffset && parseInt(uploadLength) === parseInt(uploadOffset)) {
                    addLog('âœ… Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ Ø´Ø¯! ÙØ§ÛŒÙ„ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
                    return true;
                } else {
                    addLog('âš ï¸ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'warning');
                    return false;
                }
            }
            return false;
        }

        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function toggleLog() {
            const logContainer = document.getElementById('logContainer');
            logVisible = !logVisible;
            logContainer.style.display = logVisible ? 'block' : 'none';
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('ğŸ§¹ Ù„Ø§Ú¯ Ù¾Ø§Ú© Ø´Ø¯', 'info');
        }

        // ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± (copyToken, testToken, etc.) Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø§Ø´ØªÛŒÙ…
        function copyToken() {
            if (!jwtToken) return;
            navigator.clipboard.writeText(jwtToken).then(() => {
                addLog('âœ… ØªÙˆÚ©Ù† Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
                showNotification('ØªÙˆÚ©Ù† Ú©Ù¾ÛŒ Ø´Ø¯!', 'success');
            });
        }

        function testToken() {
            if (!jwtToken) {
                addLog('âŒ ØªÙˆÚ©Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª', 'error');
                return;
            }
            
            try {
                const payload = parseJwt(jwtToken);
                const now = new Date();
                const exp = payload.exp ? new Date(payload.exp * 1000) : null;
                
                let message = 'ğŸ” Ù†ØªØ§ÛŒØ¬ ØªØ³Øª ØªÙˆÚ©Ù†:\n\n';
                message += `ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${payload.sub || 'Ù†Ø§Ù…Ø´Ø®Øµ'}\n`;
                if (payload.email) message += `ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: ${payload.email}\n`;
                if (payload.roles) message += `ğŸ‘¥ Ù†Ù‚Ø´â€ŒÙ‡Ø§: ${payload.roles.join(', ')}\n`;
                
                if (exp) {
                    const diff = exp - now;
                    const minutes = Math.floor(diff / (1000 * 60));
                    message += `â° Ø§Ù†Ù‚Ø¶Ø§: ${exp.toLocaleTimeString('fa-IR')}\n`;
                    message += `â³ Ù…Ø§Ù†Ø¯Ù‡: ${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡\n`;
                    message += minutes > 0 ? 'âœ… ÙˆØ¶Ø¹ÛŒØª: Ù…Ø¹ØªØ¨Ø±\n' : 'âš ï¸ ÙˆØ¶Ø¹ÛŒØª: Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡\n';
                } else {
                    message += 'â° Ø§Ù†Ù‚Ø¶Ø§: Ø¨Ø¯ÙˆÙ† Ø§Ù†Ù‚Ø¶Ø§\nâœ… ÙˆØ¶Ø¹ÛŒØª: Ù…Ø¹ØªØ¨Ø±\n';
                }
                
                alert(message);
                addLog('ğŸ” ØªØ³Øª ØªÙˆÚ©Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'info');
                
            } catch (error) {
                addLog(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª ØªÙˆÚ©Ù†: ${error.message}`, 'error');
            }
        }

        // Drag & Drop events
        const dropArea = document.getElementById('dropArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('dragover');
        }

        function unhighlight() {
            dropArea.classList.remove('dragover');
        }

        dropArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect();
            }
        });

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“± Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'info');
            
            // Ø¨Ø±Ø±Ø³ÛŒ URL Ø¨Ø±Ø§ÛŒ token
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                document.getElementById('jwtTokenInput').value = tokenFromUrl;
                setToken();
                addLog('ğŸ”— ØªÙˆÚ©Ù† Ø§Ø² URL Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', 'info');
            }
        });

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { top: -100px; opacity: 0; }
                to { top: 20px; opacity: 1; }
            }
            @keyframes slideOut {
                from { top: 20px; opacity: 1; }
                to { top: -100px; opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>